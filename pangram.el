;;; pangram.el --- AI content detection via Pangram API -*- lexical-binding: t; -*-

;; Copyright (C) 2025

;; Author: Pablo Stafforini
;; Version: 0.1.0
;; Package-Requires: ((emacs "29.1"))
;; Keywords: tools
;; URL: https://github.com/benthamite/pangram

;; This file is not part of GNU Emacs.

;; This program is free software: you can redistribute it and/or modify
;; it under the terms of the GNU General Public License as published by
;; the Free Software Foundation, either version 3 of the License, or
;; (at your option) any later version.

;; This program is distributed in the hope that it will be useful,
;; but WITHOUT ANY WARRANTY; without even the implied warranty of
;; MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
;; GNU General Public License for more details.

;; You should have received a copy of the GNU General Public License
;; along with this program.  If not, see <https://www.gnu.org/licenses/>.

;;; Commentary:

;; Detect AI-generated content using the Pangram Labs API (v3).
;; Highlights AI-generated and AI-assisted text segments with overlays.
;; https://pangram.readthedocs.io/en/latest/api/rest.html

;;; Code:

(require 'json)
(require 'url)
(require 'auth-source-pass)
(require 'seq)

(defgroup pangram nil
  "AI content detection via Pangram Labs."
  :group 'tools)

(defcustom pangram-api-url "https://text.api.pangram.com/v3"
  "URL for the Pangram v3 inference API."
  :type 'string
  :group 'pangram)

(defface pangram-ai
  '((((background dark)) :background "#5c2020")
    (((background light)) :background "#ffcccc"))
  "Face for AI-generated text segments."
  :group 'pangram)

(defface pangram-ai-assisted
  '((((background dark)) :background "#5c4020")
    (((background light)) :background "#fff0cc"))
  "Face for AI-assisted text segments."
  :group 'pangram)

;;;###autoload
(defun pangram-detect ()
  "Detect AI-generated content in the buffer or active region.
Sends the text to the Pangram API and highlights AI-generated and
AI-assisted segments with overlays.  Hover over highlighted text
to see the classification details."
  (interactive)
  (let* ((use-region (use-region-p))
         (beg (if use-region (region-beginning) (point-min)))
         (end (if use-region (region-end) (point-max)))
         (text (buffer-substring-no-properties beg end))
         (source-buffer (current-buffer))
         (offset beg))
    (when (string-empty-p (string-trim text))
      (error "No text to analyze"))
    (message "Sending text to Pangram API...")
    (pangram--api-call
     text
     (lambda (data)
       (pangram--handle-response data source-buffer offset)))))

;;;###autoload
(defun pangram-clear ()
  "Remove Pangram AI detection overlays from the current buffer."
  (interactive)
  (remove-overlays (point-min) (point-max) 'pangram t)
  (message "Pangram overlays cleared"))

(defun pangram--get-api-key ()
  "Retrieve the Pangram API key from auth-source-pass."
  (or (auth-source-pass-get "key"
        (concat "chrome/pangram.com/" (getenv "PERSONAL_EMAIL")))
      (error "Pangram API key not found in pass store")))

(defun pangram--encode-request-body (text)
  "Encode TEXT as a JSON request body safe for `url-retrieve'.
Escapes non-ASCII characters as \\uXXXX sequences so the result
is pure ASCII, avoiding multibyte issues in `url-http-create-request'."
  (let ((json (decode-coding-string
               (json-serialize (list :text text))
               'utf-8)))
    (replace-regexp-in-string
     "[^[:ascii:]]"
     (lambda (s)
       (pangram--escape-unicode-char (aref s 0)))
     json t t)))

(defun pangram--escape-unicode-char (char)
  "Return CHAR as a JSON \\uXXXX escape sequence.
Characters outside the Basic Multilingual Plane are encoded as
surrogate pairs."
  (if (<= char #xFFFF)
      (format "\\u%04X" char)
    (let* ((cp (- char #x10000))
           (hi (+ #xD800 (ash cp -10)))
           (lo (+ #xDC00 (logand cp #x3FF))))
      (format "\\u%04X\\u%04X" hi lo))))

(defun pangram--api-call (text callback)
  "Send TEXT to the Pangram API.
CALLBACK is called with the parsed JSON response."
  (let* ((api-key (pangram--get-api-key))
         (url-request-method "POST")
         (url-request-extra-headers
          `(("Content-Type" . "application/json")
            ("x-api-key" . ,api-key)))
         (url-request-data
          (pangram--encode-request-body text)))
    (url-retrieve
     pangram-api-url
     (lambda (status cb)
       (if (plist-get status :error)
           (progn
             (kill-buffer)
             (message "Pangram API error: %s" (plist-get status :error)))
         (let ((response (pangram--parse-response)))
           (kill-buffer)
           (funcall cb response))))
     (list callback)
     t nil)))

(defun pangram--parse-response ()
  "Parse the JSON response from the current HTTP response buffer."
  (goto-char (point-min))
  (re-search-forward "^$" nil t)
  (forward-char)
  (json-read))

(defun pangram--handle-response (data source-buffer offset)
  "Apply overlays from Pangram response DATA to SOURCE-BUFFER.
OFFSET is the buffer position corresponding to text index 0."
  (unless (buffer-live-p source-buffer)
    (error "Source buffer no longer exists"))
  (let ((windows (alist-get 'windows data))
        (headline (alist-get 'headline data))
        (fraction-ai (alist-get 'fraction_ai data))
        (fraction-assisted (alist-get 'fraction_ai_assisted data))
        (fraction-human (alist-get 'fraction_human data)))
    (with-current-buffer source-buffer
      (remove-overlays (point-min) (point-max) 'pangram t)
      (pangram--apply-overlays windows offset))
    (message "Pangram: %s â€” AI: %.0f%%, AI-assisted: %.0f%%, Human: %.0f%%"
             headline
             (* 100 fraction-ai)
             (* 100 fraction-assisted)
             (* 100 fraction-human))))

(defun pangram--apply-overlays (windows offset)
  "Create overlays for AI and AI-assisted segments in WINDOWS.
OFFSET is added to each segment's start and end indices to map
them to buffer positions.  Human segments are not highlighted."
  (seq-doseq (window windows)
    (let ((face (pangram--label-face
                 (alist-get 'label window))))
      (when face
        (pangram--make-overlay window offset face)))))

(defun pangram--make-overlay (window offset face)
  "Create a single overlay for WINDOW at OFFSET with FACE."
  (let* ((start (+ offset (alist-get 'start_index window)))
         (end (+ offset (alist-get 'end_index window)))
         (label (alist-get 'label window))
         (score (alist-get 'ai_assistance_score window))
         (confidence (alist-get 'confidence window))
         (ov (make-overlay start end)))
    (overlay-put ov 'pangram t)
    (overlay-put ov 'face face)
    (overlay-put ov 'help-echo
                 (format "%s (score: %.2f, confidence: %s)"
                         label score confidence))))

(defun pangram--label-face (label)
  "Return the face for a segment LABEL, or nil for human text."
  (cond
   ((string-match-p "AI Generated" label) 'pangram-ai)
   ((string-match-p "Human" label) nil)
   (t 'pangram-ai-assisted)))

(provide 'pangram)

;;; pangram.el ends here
